<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MDN Locations</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&family=Lato:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root{
        --brand: #044c5c;
        --text: #0b1b2a;
        --muted: #5b6b7a;
        --border: rgba(0,0,0,.10);
        --bg: #ffffff;
        --chip: rgba(4,76,92,.08);
      }

      * { box-sizing: border-box; }
      body{
        margin:0;
        padding: 22px;
        background: var(--bg);
        color: var(--text);
        font-family: Lato, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }

      .wrap{
        max-width: 920px;
        margin: 0 auto;
      }

      h1{
        margin: 2px 0 8px;
        font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        font-weight: 800;
        letter-spacing: -0.02em;
        font-size: clamp(24px, 3.2vw, 42px);
      }

      .sub{
        margin: 0 0 18px;
        color: var(--muted);
        font-size: 16px;
        line-height: 1.5;
      }

      .search{
        width: 100%;
        padding: 16px 16px;
        font-size: 16px;
        border: 1px solid var(--border);
        border-radius: 14px;
        outline: none;
        transition: box-shadow .12s ease, border-color .12s ease;
      }
      .search:focus{
        border-color: rgba(4,76,92,.45);
        box-shadow: 0 0 0 4px rgba(4,76,92,.12);
      }

      .controls{
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
        align-items:center;
      }

      select{
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        min-width: 240px;
        background: #fff;
        font-size: 14px;
      }

      .pill{
        display:inline-flex;
        align-items:center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        background: var(--chip);
        color: var(--brand);
        font-weight: 700;
        border: 1px solid rgba(4,76,92,.15);
        font-size: 13px;
      }

      .hint{
        margin-top: 12px;
        color: var(--muted);
        font-size: 13px;
      }

      .results{
        margin-top: 14px;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 16px;
        overflow: hidden;
        background:#fff;
      }

      .item{
        padding: 14px 16px;
        border-top: 1px solid rgba(0,0,0,.06);
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 14px;
      }
      .item:first-child{ border-top: none; }
      .item:hover{ background: rgba(0,0,0,.02); }

      .title{
        font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        font-weight: 800;
        font-size: 16px;
        margin: 0;
      }
      .meta{
        margin-top: 3px;
        font-size: 13px;
        color: var(--muted);
      }

      .footer{
        display:flex;
        justify-content: center; /* Book centered */
        gap: 10px;
        padding: 14px 16px;
        border-top: 1px solid rgba(0,0,0,.08);
        background: #fff;
      }

      .btn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding: 12px 18px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.12);
        cursor: pointer;
        font-weight: 800;
        font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        font-size: 14px;
        background: #fff;
        color: var(--text);
      }

      .btn-primary{
        background: var(--brand);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 26px rgba(0,0,0,.16);
      }
      .btn-primary:hover{ filter: brightness(1.06); }

      .empty{
        padding: 16px;
        color: var(--muted);
      }

      .error{
        margin-top: 10px;
        color: #b00020;
        font-size: 13px;
      }

      @media (max-width: 640px){
        body{ padding: 16px; }
        select{ min-width: 100%; }
        .item{ flex-direction: column; align-items: flex-start; }
        .footer{ justify-content: stretch; }
        .btn{ width: 100%; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Choose your location</h1>
      <p class="sub">Search by State, County/Parish, or City. Then click <b>Book Now</b>.</p>

      <input id="q" class="search" placeholder="Choose your City, State, or Country" />

      <div class="controls">
        <select id="stateSelect">
          <option value="">Select a state…</option>
        </select>

        <!-- Hidden by default (kept for internal use, not shown to user) -->
        <select id="modeSelect" style="display:none">
          <option value="county">Book by County</option>
          <option value="city">Book by City</option>
        </select>

        <span class="pill" id="modePill">Booking by County</span>
      </div>

      <div class="hint">Try “Miami”, “Broward”, “San Juan”, or “Orleans”.</div>

      <div id="results" class="results" style="display:none"></div>
      <div id="err" class="error" style="display:none"></div>
    </div>

    <script>
      const params = new URLSearchParams(location.search);

      // If you want to force city booking in some pages:
      // locations.html?redirectMode=city
      const redirectMode = (params.get("redirectMode") || "county").toLowerCase();
      const bookPath = params.get("bookPath") || "/book-service";

      const CFG = {
        statesIndexUrl:
          params.get("statesIndexUrl") ||
          "https://sitemaps.mydripnurse.com/public/ui/states-index.json",
        redirectMode,
        bookPath,
      };

      const $q = document.getElementById("q");
      const $state = document.getElementById("stateSelect");
      const $results = document.getElementById("results");
      const $err = document.getElementById("err");
      const $modePill = document.getElementById("modePill");

      // UI label only
      $modePill.textContent = CFG.redirectMode === "city" ? "Booking by City" : "Booking by County";

      function escapeHtml(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function norm(s){ return String(s||"").toLowerCase().trim(); }

      // Keep selected result in memory
      let selected = null;
      let indexData = null;

      function divisionLabel(stateName, divisionName, divisionType){
        // divisionType: counties/parishes/cities (from your index)
        // For user display:
        if (divisionType === "cities") {
          // Puerto Rico style
          return `${divisionName}, ${stateName}`;
        }
        if (divisionType === "parishes") {
          return `${divisionName} Parish, ${stateName}`;
        }
        // default
        return `${divisionName} County, ${stateName}`;
      }

      function buildRows(matches){
        $results.style.display = "block";
        $results.innerHTML = "";

        if (!matches.length){
          $results.innerHTML = `<div class="empty"><b>No results</b><div>Try typing a city or county.</div></div>`;
          return;
        }

        matches.slice(0, 20).forEach((m) => {
          const row = document.createElement("div");
          row.className = "item";

          const left = document.createElement("div");
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = m.label;

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `State: ${m.stateName}`;

          left.appendChild(title);
          left.appendChild(meta);

          const pickBtn = document.createElement("button");
          pickBtn.className = "btn";
          pickBtn.type = "button";
          pickBtn.textContent = "Select";
          pickBtn.onclick = () => {
            selected = m;
            renderFooter();
          };

          row.appendChild(left);
          row.appendChild(pickBtn);

          $results.appendChild(row);
        });

        renderFooter();
      }

      function renderFooter(){
        // remove existing footer if present
        const existing = $results.querySelector(".footer");
        if (existing) existing.remove();

        const footer = document.createElement("div");
        footer.className = "footer";

        const clearBtn = document.createElement("button");
        clearBtn.className = "btn";
        clearBtn.type = "button";
        clearBtn.textContent = "Clear";
        clearBtn.onclick = () => {
          selected = null;
          renderFooter();
        };

        const bookBtn = document.createElement("button");
        bookBtn.className = "btn btn-primary";
        bookBtn.type = "button";
        bookBtn.textContent = selected ? `Book Now` : "Book Now";
        bookBtn.disabled = !selected;
        bookBtn.style.opacity = selected ? "1" : ".55";
        bookBtn.style.cursor = selected ? "pointer" : "not-allowed";

        bookBtn.onclick = () => {
          if (!selected) return;
          const targetBase = selected.targetDomain;
          const url = new URL(targetBase);
          // keep path
          url.pathname = CFG.bookPath.startsWith("/") ? CFG.bookPath : `/${CFG.bookPath}`;
          window.top.location.href = url.toString(); // works inside iframe modal
        };

        footer.appendChild(clearBtn);
        footer.appendChild(bookBtn);

        $results.appendChild(footer);
      }

      function searchAndRender(){
        if (!indexData?.states?.length) return;

        const q = norm($q.value);
        const stateFilter = $state.value;

        const matches = [];

        for (const st of indexData.states){
          if (stateFilter && st.stateSlug !== stateFilter) continue;

          const stateName = st.stateName;
          const divisionType = st.divisionType; // counties/parishes/cities
          const divisions = st.divisions || [];

          // Match on state
          if (q && norm(stateName).includes(q)){
            matches.push({
              label: `${stateName}`,
              stateName,
              targetDomain: st.stateDomain || st.stateUrl || st.stateHome || st.stateBase || st.stateRoot || st.stateDomainFallback || st.mainDomain || st.domain || st.home || st.base || st.domainBase || st.domainRoot || st.domainHome || st.domainUrl || "",
            });
          }

          // Divisions & cities
          for (const dv of divisions){
            const dvName = dv.name;
            const dvDomain = dv.domain;

            if (q && norm(dvName).includes(q)){
              // Redirect mode decides target
              const targetDomain = (CFG.redirectMode === "city")
                ? (dv.cities?.[0]?.domain || dvDomain)
                : dvDomain;

              matches.push({
                label: divisionLabel(stateName, dvName, divisionType),
                stateName,
                targetDomain,
              });
            }

            // cities
            const cities = dv.cities || [];
            for (const ct of cities){
              const ctName = ct.name;
              const ctDomain = ct.domain;

              if (q && norm(ctName).includes(q)){
                const targetDomain = (CFG.redirectMode === "city") ? ctDomain : dvDomain;

                matches.push({
                  label: `${ctName}, ${stateName}`,
                  stateName,
                  targetDomain,
                });
              }
            }
          }
        }

        // If empty query, don't show spam
        if (!q && !stateFilter){
          $results.style.display = "none";
          $results.innerHTML = "";
          return;
        }

        buildRows(matches);
      }

      async function loadIndex(){
        try{
          $err.style.display = "none";
          const res = await fetch(CFG.statesIndexUrl, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (!data) throw new Error("Empty JSON");
          indexData = data;

          // Fill states dropdown
          $state.innerHTML = `<option value="">Select a state…</option>`;
          (data.states || []).forEach((st) => {
            const opt = document.createElement("option");
            opt.value = st.stateSlug;
            opt.textContent = st.stateName;
            $state.appendChild(opt);
          });
        }catch(e){
          $err.textContent = `Error loading states data.`;
          $err.style.display = "block";
          console.error("Index load failed:", e);
        }
      }

      // Events
      $q.addEventListener("input", () => {
        selected = null;
        searchAndRender();
      });
      $state.addEventListener("change", () => {
        selected = null;
        searchAndRender();
      });

      // Init
      loadIndex();
    </script>
  </body>
</html>
